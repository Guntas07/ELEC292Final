<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Realtime · Movement Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <nav class="bg-white/80 backdrop-blur border-b border-slate-200">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/" class="text-slate-800 font-semibold">Movement Classifier</a>
        <div class="space-x-4 text-sm">
          <a class="text-slate-600 hover:text-slate-900" href="/">CSV</a>
          <a class="text-slate-900 font-semibold" href="/realtime">Realtime</a>
        </div>
      </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 py-10">
      <header class="mb-8">
        <h1 class="text-2xl font-bold text-slate-900">Realtime Classification</h1>
        <p class="text-slate-600">Polls every 5 seconds using your PhyPhox stream.</p>
      </header>

      <section class="grid md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
          <div class="text-sm text-slate-600">Current prediction</div>
          <div id="current" class="text-3xl font-bold mt-1">—</div>
          <div id="status" class="mt-2 text-sm text-slate-500"></div>
          <button id="toggle" class="mt-4 inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-white font-medium hover:bg-indigo-500">Start</button>
        </div>

        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">Predictions</h3>
          <canvas id="predChart" height="140"></canvas>
          <div class="text-xs text-slate-500 mt-2">0 = Walking, 1 = Jumping</div>
        </div>
      </section>
    </main>

    <script>
      const currentEl = document.getElementById('current');
      const statusEl = document.getElementById('status');
      const toggleEl = document.getElementById('toggle');
      const ctx = document.getElementById('predChart');
      let timer = null;
      let values = [];
      let chart;

      function renderChart(data) {
        const labels = data.map((_, i) => i + 1);
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Prediction',
              data,
              stepped: true,
              borderColor: '#4f46e5',
              backgroundColor: 'rgba(79,70,229,0.1)',
              pointRadius: 0,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: { min: -0.1, max: 1.1, ticks: { stepSize: 1 } },
              x: { title: { display: true, text: '5-sec window' } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      async function tick() {
        try {
          statusEl.textContent = 'Polling…';
          const res = await fetch('/api/predict/realtime');
          if (!res.ok) throw new Error('Realtime endpoint failed');
          const json = await res.json();
          const p = json.prediction;
          currentEl.textContent = json.label || (p === 1 ? 'Jumping' : 'Walking');
          values.push(p);
          renderChart(values);
          statusEl.textContent = 'Updated';
        } catch (err) {
          statusEl.textContent = err.message + '. Check PhyPhox stream address.';
        }
      }

      toggleEl.addEventListener('click', () => {
        if (timer) {
          clearInterval(timer);
          timer = null;
          toggleEl.textContent = 'Start';
          statusEl.textContent = 'Paused';
          return;
        }
        values = [];
        renderChart(values);
        tick();
        timer = setInterval(tick, 5000);
        toggleEl.textContent = 'Pause';
        statusEl.textContent = 'Running';
      });
    </script>
  </body>
  </html>

